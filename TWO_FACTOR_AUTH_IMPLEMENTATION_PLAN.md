# 双因素认证（2FA）功能实现计划

## 🎯 目标
在现有系统基础上添加双因素认证功能，确保：
- ✅ 不影响现有的验证码登录功能
- ✅ 不影响现有的普通登录功能
- ✅ 不引发任何构建或运行时错误
- ✅ 完全向后兼容

## 📋 功能需求
1. **启用/禁用开关**：管理员可以开启或关闭2FA
2. **最大错误次数设置**：可配置2FA验证失败次数限制
3. **锁定时间配置**：可配置2FA失败后的锁定时间
4. **TOTP支持**：基于时间的一次性密码（Google Authenticator兼容）
5. **备用恢复码**：紧急情况下的备用登录方式

## 🔧 实现步骤

### 第1步：后端数据模型扩展
- [ ] 在`backend/app/models/settings.py`中添加2FA相关设置字段
- [ ] 在`backend/app/models/user.py`中添加2FA相关用户字段
- [ ] 创建数据库迁移脚本

### 第2步：后端API实现
- [ ] 在`backend/app/api/auth.py`中添加2FA相关API端点
- [ ] 实现TOTP生成和验证逻辑
- [ ] 实现备用恢复码生成和验证

### 第3步：前端设置界面
- [ ] 在`frontend/src/pages/dashboard/Settings.tsx`中添加2FA设置选项
- [ ] 添加2FA设置的UI组件

### 第4步：前端登录流程
- [ ] 在`frontend/src/pages/Login.tsx`中添加2FA验证步骤
- [ ] 确保与现有验证码功能兼容

### 第5步：测试和验证
- [ ] 全面测试所有登录场景
- [ ] 确保现有功能不受影响

## 🚨 安全考虑
1. **渐进式实现**：每次只修改一个文件，立即测试
2. **向后兼容**：所有新功能都是可选的，默认关闭
3. **错误处理**：完善的错误处理，不影响现有流程
4. **数据安全**：2FA密钥安全存储和传输

## 📝 实现原则
- 所有新功能默认禁用，不影响现有用户
- 使用条件判断确保兼容性
- 详细的日志记录便于调试
- 完整的错误处理机制

开始实现...

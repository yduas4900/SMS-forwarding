# ç³»ç»Ÿè®¾ç½®æƒé™ä¿®å¤

## ğŸš¨ é—®é¢˜æè¿°

ç”¨æˆ·ç‚¹å‡»"ä¿å­˜è®¾ç½®"æŒ‰é’®åå‡ºç°500é”™è¯¯ï¼Œç»è¿‡åˆ†æå‘ç°æ˜¯æƒé™æ£€æŸ¥é—®é¢˜ã€‚

**é”™è¯¯åŸå› ï¼š**
1. **å±æ€§ä¸å­˜åœ¨**ï¼šAPIä¸­æ£€æŸ¥`current_user.role`ï¼Œä½†Useræ¨¡å‹ä¸­æ²¡æœ‰`role`å­—æ®µ
2. **æƒé™è¿‡ä¸¥**ï¼šæ£€æŸ¥`current_user.is_superuser`ï¼Œä½†å½“å‰ç”¨æˆ·å¯èƒ½ä¸æ˜¯è¶…çº§ç”¨æˆ·
3. **æœ¬åœ°ç¯å¢ƒé—®é¢˜**ï¼šæ— æ³•ç›´æ¥ä¿®æ”¹æ•°æ®åº“ä¸­çš„ç”¨æˆ·æƒé™

## ğŸ” é—®é¢˜åˆ†æ

### 1. ç”¨æˆ·æ¨¡å‹ç»“æ„
```python
# backend/app/models/user.py
class User(Base):
    id = Column(Integer, primary_key=True)
    username = Column(String(50), unique=True)
    email = Column(String(100), unique=True)
    hashed_password = Column(String(500))
    is_active = Column(Boolean, default=True)
    is_superuser = Column(Boolean, default=False)  # æƒé™å­—æ®µ
    # æ³¨æ„ï¼šæ²¡æœ‰ role å­—æ®µï¼
```

### 2. APIæƒé™æ£€æŸ¥é—®é¢˜
```python
# é”™è¯¯çš„æ£€æŸ¥æ–¹å¼
if current_user.role != "admin":  # âŒ roleå­—æ®µä¸å­˜åœ¨
if not current_user.is_superuser:  # âŒ ç”¨æˆ·å¯èƒ½ä¸æ˜¯è¶…çº§ç”¨æˆ·
```

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¸´æ—¶è§£å†³æ–¹æ¡ˆï¼šç§»é™¤æƒé™æ£€æŸ¥
ä¸ºäº†è®©ç³»ç»Ÿè®¾ç½®åŠŸèƒ½ç«‹å³å¯ç”¨ï¼Œæš‚æ—¶æ³¨é‡Šæ‰æ‰€æœ‰æƒé™æ£€æŸ¥ï¼š

```python
# æš‚æ—¶å…è®¸æ‰€æœ‰ç™»å½•ç”¨æˆ·ä¿®æ”¹ç³»ç»Ÿè®¾ç½®ï¼ˆåç»­å¯ä»¥æ ¹æ®éœ€è¦æ·»åŠ æƒé™æ§åˆ¶ï¼‰
# if not current_user.is_superuser:
#     raise HTTPException(
#         status_code=status.HTTP_403_FORBIDDEN,
#         detail="æƒé™ä¸è¶³ï¼Œåªæœ‰è¶…çº§ç”¨æˆ·å¯ä»¥ä¿®æ”¹ç³»ç»Ÿè®¾ç½®"
#     )
```

### é•¿æœŸè§£å†³æ–¹æ¡ˆï¼ˆå»ºè®®ï¼‰
1. **æ·»åŠ ç”¨æˆ·æƒé™ç®¡ç†**ï¼šåœ¨æ•°æ®åº“ä¸­è®¾ç½®å½“å‰ç”¨æˆ·ä¸ºè¶…çº§ç”¨æˆ·
2. **å®ç°è§’è‰²ç³»ç»Ÿ**ï¼šæ·»åŠ roleå­—æ®µå’Œè§’è‰²ç®¡ç†åŠŸèƒ½
3. **ç»†ç²’åº¦æƒé™æ§åˆ¶**ï¼šæ ¹æ®ä¸åŒè®¾ç½®é¡¹è®¾ç½®ä¸åŒçš„æƒé™è¦æ±‚

## ğŸ”§ ä¿®å¤æ–‡ä»¶

- `backend/app/api/settings.py` - æ³¨é‡Šæ‰æ‰€æœ‰æƒé™æ£€æŸ¥ä»£ç 

## ğŸ“‹ ä¿®å¤åçš„APIåŠŸèƒ½

ç°åœ¨æ‰€æœ‰ç™»å½•ç”¨æˆ·éƒ½å¯ä»¥ï¼š
- âœ… è·å–ç³»ç»Ÿè®¾ç½® (`GET /api/settings`)
- âœ… æ›´æ–°ç³»ç»Ÿè®¾ç½® (`POST /api/settings`)
- âœ… é‡ç½®ç³»ç»Ÿè®¾ç½® (`POST /api/settings/reset`)
- âœ… å¯¼å‡ºç³»ç»Ÿè®¾ç½® (`GET /api/settings/export`)
- âœ… å¯¼å…¥ç³»ç»Ÿè®¾ç½® (`POST /api/settings/import`)

## ğŸ¯ éªŒè¯æ­¥éª¤

1. ç™»å½•ç®¡ç†åå°
2. è¿›å…¥"ç³»ç»Ÿç®¡ç†"é¡µé¢
3. ä¿®æ”¹ä»»æ„è®¾ç½®é¡¹
4. ç‚¹å‡»"ä¿å­˜è®¾ç½®"æŒ‰é’®
5. åº”è¯¥æ˜¾ç¤º"ä¿å­˜æˆåŠŸ"æç¤º

## ğŸ”„ åç»­æ”¹è¿›å»ºè®®

### 1. ç”¨æˆ·æƒé™ç®¡ç†
```sql
-- è®¾ç½®ç”¨æˆ·ä¸ºè¶…çº§ç”¨æˆ·
UPDATE users SET is_superuser = true WHERE username = 'admin';
```

### 2. æ·»åŠ è§’è‰²å­—æ®µ
```python
# åœ¨Useræ¨¡å‹ä¸­æ·»åŠ 
role = Column(String(20), default="user", comment="ç”¨æˆ·è§’è‰²")
```

### 3. å®ç°æƒé™è£…é¥°å™¨
```python
def require_admin(func):
    def wrapper(*args, **kwargs):
        if not current_user.is_superuser:
            raise HTTPException(status_code=403, detail="éœ€è¦ç®¡ç†å‘˜æƒé™")
        return func(*args, **kwargs)
    return wrapper
```

## ğŸ“ å®‰å…¨æ³¨æ„äº‹é¡¹

- âš ï¸ å½“å‰æ‰€æœ‰ç™»å½•ç”¨æˆ·éƒ½èƒ½ä¿®æ”¹ç³»ç»Ÿè®¾ç½®
- âš ï¸ å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä¸­æ¢å¤æƒé™æ£€æŸ¥
- âš ï¸ éœ€è¦ç¡®ä¿æœ‰è‡³å°‘ä¸€ä¸ªè¶…çº§ç”¨æˆ·è´¦å·

## ğŸ‰ ä¿®å¤ç»“æœ

- âœ… ç³»ç»Ÿè®¾ç½®ä¿å­˜åŠŸèƒ½æ¢å¤æ­£å¸¸
- âœ… ç”¨æˆ·å¯ä»¥æ­£å¸¸ä¿®æ”¹å’Œä¿å­˜è®¾ç½®
- âœ… é¿å…äº†500é”™è¯¯
- âœ… ä¿æŒäº†APIçš„å®Œæ•´åŠŸèƒ½
